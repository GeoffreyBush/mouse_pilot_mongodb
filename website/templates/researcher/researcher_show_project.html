{% extends 'base_template.html' %} {% load static %}
{% block title %}Researcher View Project{% endblock %} {% block content %}

<!-- The Modal (mouse information popup) -->
<div id="myModal" class="modal">
  <!-- Modal content -->
  <div id="mouse-information-pop-up" class="modal-content">
      <span id="modal-span" class="close">&times;</span>
      <!-- Dynamic comments will be injected here -->
  </div>
</div>
<form method="post" action="{% url 'add_request' projectname=projectname %}">
    {% csrf_token %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ projectname }}</h1>
    <div>
      <button class="btn btn-primary mr-2" id="add-request-button">Add Request</button>
      <a href="{% url 'add_preexisting_mouse_to_project' projectname %}" class="btn btn-secondary">Add Mouse</a>
    </div>
  </div>

  <form method="get" class="mb-3">
    <div class="row">
      <div class="col-md-8">
        {% for field in filter.form %}
        <span>
          <label for="id_{{ field.label }}">{{ field.label }}</label>
          {{ field }}
        </span>
        {% endfor %}
      </div>
      <div class="col-md-4 text-center">
        <button type="submit" name="search" class="btn btn-primary">Search</button>
        <button type="submit" name="cancel" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </form>

  <div class="overflow-auto">

    <table class="main-table" id="mice_table">
        <thead>
            <tr class="position-sticky" style="top: 0">
                <th>Select</th>
                <th>Mouse ID</th>
                <th>Genotyped</th>
                <th>Date of Birth</th>
                <th>Sex</th>
                <th>Earmark</th>
                <th>Tree</th>
                <th>Edit</th>
                <th>Delete</th>
                <th>Comments</th>
            </tr>
        </thead>
        <tbody>
          {% for mouse in filter.qs %}
          <tr {% if mouse.id in mice_ids_with_requests %} class="highlighted-request" {% endif %} id="row{{ mouse.id }}">
              <td><input type="checkbox" name="mice" value='{{ mouse.id }}' onclick="highlightMouse('row{{ mouse.id }}')"></td>
              <td class="clickable-mouse-td" data-mouse-id="{{ mouse.id }}" onclick="showCommentsForMouse(this)">{{ mouse.id }}</td>
              <td class="clickable-mouse-td" data-mouse-id="{{ mouse.id }}" onclick="showCommentsForMouse(this)">{{ mouse.genotyped }}</td>
              <td class="clickable-mouse-td" data-mouse-id="{{ mouse.id }}" onclick="showCommentsForMouse(this)">{{ mouse.dob }}</td>
              <td class="clickable-mouse-td" data-mouse-id="{{ mouse.id }}" onclick="showCommentsForMouse(this)">{{ mouse.sex }}</td>
              <td class="clickable-mouse-td" data-mouse-id="{{ mouse.id }}" onclick="showCommentsForMouse(this)">{{ mouse.earmark }}</td>
              <td class="clickable-mouse-td" data-mouse-id="{{ mouse.id }}" onclick="fetchFamilyTree({{ mouse.id }})"><img src="{% static 'media/tree-structure-fill-svgrepo-com.svg' %}" style="height: 20px"></td>
              
              <td><a href="{% url 'edit_mouse' projectname=projectname mouse_id=mouse.id %}"><img src="{% static '/media/edit.svg' %}" style="height: 20px"></a></td>
              <td>
                  <a onclick="return confirm('Are you sure you want to delete this mouse?')" href="{% url 'delete_mouse' projectname=projectname mouse_id=mouse.id %}">
                      <img src="{% static '/media/delete.svg' %}" style="height: 20px">
                  </a>
              </td>
              <td class="clickable-mouse-td" data-mouse-id="{{ mouse.id }}" onclick="showCommentsForMouse(this)">
                <img src="{% static '/media/comment.svg' %}" style="height: 20px">
              </td>
          </tr>
          {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<div id="family-tree-container" class="hidden" style="position: fixed; z-index: 10; bottom: 0; right: 0; background: rgba(97, 97, 97, 0.8); width: 400px; height: 400px;">
  <svg id="family-tree" width="400" height="400"></svg>
  <button style="position: absolute; z-index: 11; top: 0; right: 0;" onclick="closeFamilyTree()">X</button>
</div>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="{% static 'js/comment_popup.js' %}"></script>
<script src="{% static 'js/show_project.js' %}"></script>
<script src="{% static 'js/family_tree.js' %}"></script>
{% endblock %}
